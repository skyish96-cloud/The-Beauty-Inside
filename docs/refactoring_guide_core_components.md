# 핵심 컴포넌트 구조 개선(Refactoring) 가이드

이 문서는 프로젝트의 핵심 로직인 `AnalyzePipeline`과 `CelebDataLoader`의 현재 구조적 한계와, 이를 장기적으로 어떻게 개선해야 하는지에 대한 제안을 담고 있습니다.

---

## 1. AnalyzePipeline (`analyze_pipeline.py`)

### 🔍 왜 수정해야 할까요? (Why)
1.  **높은 결합도 (High Coupling)**:
    - 현재 파이프라인이 이미지 디코딩, 얼굴 감지, 임베딩, 매칭 등 모든 단계의 **구체적인 구현 클래스**를 직접 생성하고 알고 있습니다.
    - 새로운 분석 단계(예: 나이 추정)를 추가하려면 파이프라인 코드를 직접 뜯어고쳐야 합니다. (개방-폐쇄 원칙 위배)
2.  **테스트의 어려움**:
    - 모든 기능이 묶여 있어, "유사도 계산"만 따로 떼어서 테스트하기가 까다롭습니다.
3.  **예외 처리의 복잡성**:
    - 각 단계에서 발생하는 에러를 파이프라인 한 곳에서 모두 처리하려다 보니 `try-catch` 블록이 비대해집니다.

### 🛠 어떻게 바꿔야 할까요? (How)
**"책임 연쇄 패턴 (Chain of Responsibility)"** 또는 **"각 단계를 독립적인 Unit으로 분리"**를 추천합니다.

1.  **Step 인터페이스 정의**:
    - `ITaskStep` 같은 인터페이스를 만들고, `process(input) -> output` 메서드만 정의합니다.
2.  **단계별 클래스 분리**:
    - `DecodingStep`, `FaceDetectionStep`, `EmbeddingStep` 등 각 단계를 독립된 클래스로 분리합니다.
3.  **파이프라인은 '순서'만 관리**:
    - `AnalyzePipeline`은 구체적인 로직을 몰라도 됩니다. 단순히 "Step 1 실행 -> 결과 -> Step 2 실행" 흐름만 관리하도록 경량화합니다.

```python
# (예시) 변경 후 모습 상상도
pipeline.add_step(DecodingStep())
        .add_step(FaceDetectionStep())
        .add_step(EmbeddingStep())

result = pipeline.run(image_data)
```

---

## 2. CelebDataLoader (`loader.py`)

### 🔍 왜 수정해야 할까요? (Why)
1.  **단일 책임 원칙 위반**:
    - 이 클래스는 "데이터를 파일에서 읽는 역할(IO)"과 "메모리에 저장하고 제공하는 역할(State)"을 동시에 하고 있습니다.
    - 데이터 형식이 CSV에서 DB로 바뀌면, 메모리 저장소 코드를 다 뜯어고쳐야 합니다.
2.  **초기화 위험성 (Initialization Risk)**:
    - 싱글톤 패턴(`__new__`)과 초기화 로직이 섞여 있어, 자칫하면 초기화가 두 번 일어나거나, 데이터가 로딩되지 않은 상태로 앱이 켜질 위험이 있습니다.
3.  **메모리 확장성 한계**:
    - 연예인 데이터가 100만 명이 되면, 서버 메모리가 터질 수 있습니다. 현재 구조는 **모든 데이터를 메모리에 올리는** 방식이기 때문입니다.

### 🛠 어떻게 바꿔야 할까요? (How)
**"저장소 패턴 (Repository Pattern)"** 도입 및 **"역할 분리"**가 필요합니다.

1.  **Repository 도입**:
    - `CelebRepository`를 만들어 "데이터를 가져오는 방법(파일, DB, Redis)"을 추상화합니다.
    - 비즈니스 로직은 데이터가 파일에 있는지 DB에 있는지 알 필요가 없게 해야 합니다.
2.  **캐싱 레이어 분리**:
    - 원본 데이터 로딩과 메모리 캐싱(LRU Cache, Redis 등)을 분리합니다.
    - 자주 찾는 연예인만 메모리에 올리거나, Redis 같은 외부 캐시 저장소를 사용하도록 변경합니다.
3.  **의존성 주입 (Dependency Injection)**:
    - 싱글톤 객체를 전역 변수(`celeb_loader`)로 직접 쓰지 말고, FastAPI의 `Depends`를 통해 필요한 곳에 주입받아 쓰도록 변경합니다. 이렇게 하면 테스트할 때 가짜 데이터(Mock)를 넣기 쉬워집니다.

---

### ✅ 요약
- **파이프라인**: "지휘자"가 너무 많은 일을 하지 않게, 각 "연주자(Step)"에게 권한을 위임하세요.
- **데이터로더**: "창고지기(Repository)"를 고용해서, 데이터를 어디서 가져올지 고민하지 않게 만드세요.
